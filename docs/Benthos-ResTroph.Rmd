---
title: "Benthos-ResTroph"
author: ""
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    navbar:
      - { title: "Accueil RSerena", href: "accueil.html", align: rigth }
---
<style>                     
.navbar {
  background-color:#CDBE70;
  border-color:#006400;}
  .navbar-inverse .navbar-nav > li > a:hover,
.navbar-inverse .navbar-nav > li > a:focus {
    background-color: #e7d679;
    color: black;}
.navbar-inverse .navbar-nav > .active > a,
.navbar-inverse .navbar-nav > .active > a:hover,
.navbar-inverse .navbar-nav > .active > a:focus {
  color: white;
  background-color: #544b20;}
.navbar-brand {
color:white!important;}
.chart-title {
  color: #006400;}
.nav-tabs-custom > .nav-tabs > li.active {border-top-color: #CCCCCC}
.nav-tabs-custom .nav-tabs li.active a {color: blue;}
.nav-tabs-custom .nav-tabs li:not(.active) a { color: #8A857C;}
.chart-title {color: #006400;}
</style>
 

```{r setup, include=FALSE}
####################################
#initialisation
library(flexdashboard)
library(readxl)
library(lattice)
library(leaflet)
library(sf)
library(dismo)
library(htmlwidgets)
library(crosstalk)
library(dplyr) 
library(leafem)
library(DT)
library(doBy)
library(htmltools)
######################################
#ouverture data 87
adres<-gsub("Analyse-script",  "data/benthos1987t.xlsx"  ,getwd())
dataI87 <- as.data.frame(read_excel(adres,sheet = "intertidal_87"))
dataS587 <- as.data.frame(read_excel(adres,sheet = "subtidal5_87"))
dataS287 <- as.data.frame(read_excel(adres,sheet = "subtidal2_87"))
station87 <- as.data.frame(read_excel(adres,sheet = "station"))
mambiI87 <- as.data.frame(read_excel(adres,sheet = "inter_ambi_87"))
mambiS87 <- as.data.frame(read_excel(adres,sheet = "sub_ambi_87"))
#ouverture data 01
adres<-gsub("Analyse-script",  "data/benthos2001t.xlsx"  ,getwd())
data01 <- as.data.frame(read_excel(adres,sheet = "intertidal_01"))
station01 <- as.data.frame(read_excel(adres,sheet = "station"))
mambi01 <- as.data.frame(read_excel(adres,sheet = "ambi_01"))
#ouverture des data 10
adres<-gsub("Analyse-script","data/benthos2010t.xlsx"  ,getwd())
data10 <- as.data.frame(read_excel(adres,sheet = "intertidal_10"))
station10 <- as.data.frame(read_excel(adres,sheet = "station"))
mambi10 <- as.data.frame(read_excel(adres,sheet = "ambi_10"))
#ouverture data 11
adres<-gsub("Analyse-script","data/benthos2011t.xlsx"  ,getwd())
data11 <- as.data.frame(read_excel(adres,sheet = "intertidal_11"))
station11 <- as.data.frame(read_excel(adres,sheet = "station"))
mambi11 <- as.data.frame(read_excel(adres,sheet = "ambi_11"))
#ouverture data 19
adres<-gsub("Analyse-script","data/benthos2019.xlsx"  ,getwd())
dataI19 <- as.data.frame(read_excel(adres,sheet = "intertidal_19"))
dataS519 <- as.data.frame(read_excel(adres,sheet = "subtidal5_19"))
dataS219 <- as.data.frame(read_excel(adres,sheet = "subtidal2_19"))
station19 <- as.data.frame(read_excel(adres,sheet = "station"))
mambiI19 <- as.data.frame(read_excel(adres,sheet = "inter_ambi_19"))
mambiS19 <- as.data.frame(read_excel(adres,sheet = "sub_ambi_19"))
#%tableau taxo global
adres<-gsub("Analyse-script","data/synthèse général benthos BSB.xlsx",getwd())
taxo <- as.data.frame(read_excel(adres,sheet = "tot"))
colnames(taxo)<-taxo[1,]
taxo<-taxo[-1,]
#element cartes interactives
adres2<-gsub("Analyse-script",
             "data/SIG/Iso_0m.shp",getwd())
zero<-st_read(adres2)
adres2<-gsub("Analyse-script",
             "data/SIG/Iso-5m.shp",getwd())
i5m<-st_read(adres2)
adres2<-gsub("Analyse-script",
             "data/SIG/Iso-10m.shp",getwd())
i10m<-st_read(adres2)
adres2<-gsub("Analyse-script",
             "data/SIG/Perimetre projet Restroph.shp",getwd())
zoneADE<-st_read(adres2)
adres3<-gsub("Analyse-script",
             "data/SIG/mi-marreL93.gpkg",getwd())
mimaree<-st_read(adres3) 
#logo
#img<-"http://www.reservebaiedesaintbrieuc.com/wp-content/uploads/2019/02/logo-ResTroph.jpg"
img2<-"https://www.vivarmor.fr/wp-content/uploads/2020/04/logo-ResTrophAEau-2.jpg"
#####################################
#prepa data especes 1987
####################################
#benthos subtital 1987
tmp<-merge(dataS587[,-c(2,3)],dataS287[,-c(2,3)],
             by.x = "sp", by.y = "sp",all.x=T,all.y=T)
tmp[is.na(tmp)] <- 0
dataS87<-tmp[,c(1:(dim(dataS587)[2]-2))]
#somme des 5 et 2mm/m2 (en proportion 4 tamis+1tamis)
for ( i in 2:(dim(dataS587)[2]-2)) {
  dataS87[,i]<-(tmp[,i]/2+tmp[,(i+52)]/8)*(8/5)}
#data87 unique Inter et sub
#etiquette sp
eti87<-unique(rbind(dataI87[,c(1:3)],dataS587[,c(1:3)],dataS287[,c(1:3)]))
#benthos total
data87<-merge(dataI87[,-c(2,3)],dataS87,
              by.x = "sp", by.y = "sp",all.x=T,all.y=T)
row.names(data87)<-data87$sp
data87<-data87[,-1]
data87[is.na(data87)] <- 0
#data avec les etiquettes
data87<-merge(eti87,data87,
              by.x = "sp", by.y = "row.names")
#ambi87 total
mambi87<-rbind(mambiI87,mambiS87)
mambi87<-merge(mambi87,station87,
              by.x = "st", by.y = "Id",all.x=T,all.y=F)
mambi87$camp<-1987
#####################################
#prepa data especes 2019
###################################
#benthos subtital 2019
tmp<-merge(dataS519[,-c(2,3)],dataS219[,-c(2,3)],
             by.x = "sp", by.y = "sp",all.x=T,all.y=T)
tmp[is.na(tmp)] <- 0
dataS19<-tmp[,c(1:(dim(dataS519)[2]-2))]
#somme des 5 et 2mm/m2 (en proportion 4 tamis+1tamis)
for ( i in 2:(dim(dataS519)[2]-2)) {
  dataS19[,i]<-(tmp[,i]/2+tmp[,(i+40)]/8)*(8/5)}
#data87 unique Inter et sub
#etiquette sp
eti19<-unique(rbind(dataI19[,c(1:3)],dataS519[,c(1:3)],dataS219[,c(1:3)]))
#benthos total
data19<-merge(dataI19[,-c(2,3)],dataS19,
              by.x = "sp", by.y = "sp",all.x=T,all.y=T)
row.names(data19)<-data19$sp
data19<-data19[,-1]
data19[is.na(data19)] <- 0
#data avec les etiquettes
data19<-merge(eti19,data19,
              by.x = "sp", by.y = "row.names")
#station19<-station19[station19$Projet %in% c("oui"),]
#ambi19 total
mambi19<-rbind(mambiI19,mambiS19)
mambi19<-merge(mambi19,station19,
              by.x = "st", by.y = "Id",all.x=T,all.y=F)
mambi19<-mambi19[,-c(17)]#supp dernier col anse
mambi19$camp<-2019
######################################
#prepa tab
B1987<-data87[,-c(2:3)]
B2001<-data01[,-c(2:3)]
B2010<-data10[,-c(2:3)]
B2011<-data11[,-c(2:3)] 
B2019<-data19[,-c(2:3)] 
colnames(B1987)<-paste("87.",colnames(B1987) ,sep="")
colnames(B2001)<-paste("01.",colnames(B2001) ,sep="")
colnames(B2010)<-paste("10.",colnames(B2011) ,sep="")
colnames(B2011)<-paste("11.",colnames(B2011) ,sep="")
colnames(B2019)<-paste("19.",colnames(B2019) ,sep="")
#association des datas
tmp1 <- merge(B1987, B2001,by.x = "87.sp", by.y = "01.sp",all.x=T,all.y=T)
tmp2 <- merge(tmp1, B2010,by.x = "87.sp", by.y = "10.sp",all.x=T,all.y=T)
tmp3 <- merge(tmp2, B2011,by.x = "87.sp", by.y = "11.sp",all.x=T,all.y=T)
tmp4 <- merge(tmp3, B2019,by.x = "87.sp", by.y = "19.sp",all.x=T,all.y=T)
tmp4[is.na(tmp4)]<-0
#ensemble des stations
st<-rbind(station87[,4:6],station01[,4:6],station10[,4:6],
          station11[,4:6],station19[,4:6])
sp<-tmp4[,1]
#ensemble des sp
eti<-unique(rbind(dataI87[,c(1:3)],dataS287[,c(1:3)],dataS587[,c(1:3)],
                    data01[,c(1:3)],data10[,c(1:3)],data11[,c(1:3)],
                  dataI19[,c(1:3)],dataS219[,c(1:3)],dataS519[,c(1:3)]))
eti<-eti[order(eti$sp),]
#ajout taxonomie
eti<-as.data.frame(merge(eti,taxo[,c(3,5,6,7,8)],by.x = "sp", by.y = "sp",all.x=T))
# en longueur
ldata<-stack(tmp4[,-1])
STi<-data.frame(st=ldata$ind,
                sp= rep(sp,length.out=dim(ldata)[1]),
                label= rep(eti$label,length.out=dim(ldata)[1]),
                gr= rep(eti$labelG,length.out=dim(ldata)[1]),
                lat= rep(st$Y,each=length(sp)),
                long= rep(st$X,each=length(sp)),
                camp= rep(st$camp,each=length(sp)),
                eff=ldata$values)
#suppresssion abence
STi<-STi[STi$eff>0,]
#recode groupe taxo
STi$gr<-recodeVar(STi$gr, 
   c("AnPe","AnPs","Cnid","CrusA","CrusCu","CrusD","CrusC","CrusCo",
"CrusIso","CrusM","CrusT","CrusL","Echi","MolBiv","MolGast",
"MolP","MolS","Nem","Sipunc","Platelm","Tuni"), 
   c("annelide-polychete-predateur","annelide-polychete-sedentaire","cnidaire","crustacés-amphipodes","crustacés-cumacés",
"crustacés-décapodes","crustacés cirripédes","copépodes",
"crustacés-isopodes","crustacés-mysidacés","crustacés-anaidaces",
"crustacés-leptostraca","echinoderme","mollusques-bivalves","mollusques-gasteropodes","mollusques-Polyplacophore","mollusques-Scaphopoda","nemerte","Siponcles","Platyhelminthes","Chordés-Tuniciers"))
#corretion nom station (suppression X)
STi$st<-gsub(".x","",STi$st)
#reprojection en wgs
coordinates(STi)=~long+lat
proj4string(STi) <- "+init=epsg:2154"
STi<-spTransform (STi, CRS("+init=epsg:4326"))#wgs
STi<-as.data.frame(STi)
sd <- SharedData$new(STi)
##########################################
#prepa-tab ambi
mambi01r<-merge(mambi01,station01,
               by.x = "st", by.y = "Id",all.x=T,all.y=F)
mambi01r$camp<-2001
mambi10r<-merge(mambi10,station10,
               by.x = "st", by.y = "Id",all.x=T,all.y=F)
mambi10r$camp<-2010
mambi11r<-merge(mambi11,station11,
               by.x = "st", by.y = "Id",all.x=T,all.y=F)
mambi11r$camp<-2011

#suppression station fond anses
mambi87r<-mambi87[!mambi87$st %in% c("1","2","3","4","5","12","24",
                                     "34","35"),]
mambi01r<-mambi01r[!mambi01r$st %in% c("1","2","3","4","5","12","24",
         "34","35","120","121","122","123","124"),]
mambi19r<-mambi19[!mambi19$st %in% c("1","2","3","4","5","12","24","34",
                                     "35"),]
mambi10r<-mambi10r[!mambi10r$st %in% c("131","130","129","127",
"123","124","125","126","118","119","120","128","121","122",
"76","77","78","88","89","90","93","94","95","99","100","101","102",
"103","104","105","106","109","111","113","114","115","116","117"), ]
mambi11r<-mambi11r[!mambi11r$st %in% c("131","130","129","127",
"123","124","125","126","118","119","120","128","121","122",
"76","77","78","88","89","90","93","94","95","99","100","101","102",
"103","104","105","106","109","111","113","114","115","116","117"), ]
#tab gen
mambi<-rbind(mambi87r,mambi01r,mambi10r,mambi11r,mambi19r)
#en long
lindice<-stack(mambi[,c(7,9)])
INi<-data.frame(st=rep(mambi[,c(1)],length.out=dim(lindice)[1]),
                lat= rep(mambi$Y,length.out=dim(lindice)[1]),
                long= rep(mambi$X,length.out=dim(lindice)[1]),
                camp= rep(mambi$camp,length.out=dim(lindice)[1]),
                Tind=lindice$ind,
                Vind=lindice$values)
#proj
coordinates(INi)=~long+lat
proj4string(INi) <- "+init=epsg:2154"
mambiI<-spTransform (INi, CRS("+init=epsg:4326"))#wgs
mambiI<-as.data.frame(mambiI)
sdM <- SharedData$new(mambiI)

#######################################
#fond carte interactive
#######################################
#limite zone en wgs
zone<-st_transform (zoneADE, CRS("+init=epsg:4326"))#wgs
Nzero<-st_transform (zero, CRS("+init=epsg:4326"))#wgs
Ni5m<-st_transform (i5m, CRS("+init=epsg:4326"))#wgs
Ni10m<-st_transform (i10m, CRS("+init=epsg:4326"))#wgs
mimar<-st_transform (mimaree, CRS("+init=epsg:4326"))#wgs
f<-leaflet(sd) %>% addTiles(attribution=
  '<a href="http://www.reservebaiedesaintbrieuc.com/">
projet ResTroph-RNN Baie St Brieuc</a>')%>%
  addProviderTiles(providers$Esri.WorldImagery)%>%
  addPolygons(data = zone, fill = T, stroke = TRUE, color = "#8B0000",
              fillColor = "white",weight = 0, group="ResTroph")%>%
  addPolylines(data = Nzero, fill = T, stroke = TRUE, color = "#FFFFFF",
               fillColor = "transparent",weight = 1,popup ="ligne 0m")%>% 
  addScaleBar(position="topright", 
              options = scaleBarOptions(imperial=F)) %>% 
  addMouseCoordinates(epsg = "EPSG:2154")%>%
  #addLogo(img,height=60,width =130)%>%
  addLogo(img2,height=60,width =190)%>%
addPolylines(data = Ni5m, fill = T, stroke = TRUE, color = "#1B8BDB",
               fillColor = "transparent",weight = 1,popup ="ligne -5m")%>%
  addPolylines(data = Ni10m, fill = T, stroke = TRUE, color = "#1B27DB",
               fillColor = "transparent",weight = 1,popup ="ligne -10m")%>%
  addPolylines(data = mimar, fill = T, stroke = TRUE, color = "#8B0000",
               fillColor = "transparent",weight = 1,popup ="ligne de mi-marée")
fi<-leaflet(sdM) %>% addTiles(attribution=
  '<a href="http://www.reservebaiedesaintbrieuc.com/">
projet ResTroph-RNN Baie St Brieuc</a>')%>%
  addProviderTiles(providers$Esri.WorldImagery)%>%
  addPolygons(data = zone, fill = T, stroke = TRUE, color = "#8B0000",
              fillColor = "white",weight = 0, group="ResTroph")%>%
  addPolylines(data = Nzero, fill = T, stroke = TRUE, color = "#FFFFFF",
               fillColor = "transparent",weight = 1,popup ="ligne 0m")%>% 
  addScaleBar(position="topright", 
              options = scaleBarOptions(imperial=F)) %>% 
  addMouseCoordinates(epsg = "EPSG:2154")%>%
  #addLogo(img,height=60,width =130)%>%
  addLogo(img2,height=60,width =190)%>%
  addPolylines(data = Ni5m, fill = T, stroke = TRUE, color = "#1B8BDB",
               fillColor = "transparent",weight = 1,popup ="ligne -5m")%>%
  addPolylines(data = Ni10m, fill = T, stroke = TRUE, color = "#1B27DB",
               fillColor = "transparent",weight = 1,popup ="ligne -10m")%>%
  addPolylines(data = mimar, fill = T, stroke = TRUE, color = "#8B0000",
               fillColor = "transparent",weight = 1,popup ="ligne de mi-marée")
```




cartes {data-icon="ion-compass"}
=====================================  

Column {data-width=400}
-------------------------------------

###

```{r filters}
filter_select(div(style = css(width="100%")),
  id = "sp",
  label = "liste des taxons",
  sharedData = sd,
  group = ~sp)

bscols(div(style = css(width="200%")),
  filter_select(
    id = "gr",
    label = "groupe taxonomique",
    sharedData = sd,
    group = ~gr),
  filter_checkbox(
    id = "camp",
    label = "campagne",
    sharedData = sd,
    group = ~camp))

```



```{r datatable}
sd%>% 
  datatable(
    #filter = "top",  
    extensions = c("Scroller"),
    rownames = F,
    style = "bootstrap",
    class = "compact",
    width = "50%",
    options = list(
      dom = "lrtip",#"lfrtip",
      deferRender = T,
      scrollY = 300,
      scroller = TRUE,
      columnDefs = list(list(visible = FALSE,targets = c(2,3,4,6,7)))))
```
    


Column {data-width=800}
-------------------------------------
    
### Carte des taxons observées
    
```{r map}
f %>%
  addCircles(
    data = STi,
    lng = ~coords.x1,   # longitude
    lat = ~coords.x2,   # latitude
    popup = ~paste0(
      "station : ", st, "<br/>",
      sp, "<br/>",
      "effectifs : ", eff, "/m2"
    ),
    fillOpacity = 1,
    opacity = 0.8,
    radius = ~eff / 15,
    color = ~ifelse(
      camp == 1987, "#FFA500",
      ifelse(camp == 2001, "#FF4040",
      ifelse(camp == 2011, "#008B8B",
      ifelse(camp == 2010, "#0D00FF", "#0DC700")))
    )
  )
#addAwesomeMarkers(popup = ~paste0("station :",STi$Id,"<br/>",
#    STi$ind, "<br/>","effectifs : ",STi$values,"/m2"))
#addCircleMarkers(weight = 1,radius =STi$values/100,
                       #fillOpacity = 0.8)
```




Mambi {data-icon="fa-check-double"}
=====================================
Column {data-width=200}
-------------------------------------

###

```{r filters2}
filter_select(
  id = "Tind", multiple = F,
  label = "indices",allLevels = T,
  sharedData = sdM,
  group = ~Tind)

bscols(div(style = css(width="100%")),
  filter_checkbox(
    id = "camp",
    label = "campagne",
    sharedData = sdM,
    group = ~camp))

```

### Indices biologiques
AMBI et M-AMBI : indices marins de la qualité écologique du benthos de substrat meuble. Ils sont basés sur les abondances relatives de cinq groupes écologiques définis selon un gradient de sensibilité/tolérance à un stress environnemental.





Column {data-width=800}
-------------------------------------
    
### Carte des indices biologiques
    
```{r map2}
#mambi
bins <- c(-1,0.2,0.39,0.53,0.77,2)
pal <- colorBin(c("red","orangered","yellow","green","blue"),
                domain = mambiI$Vind,pretty = T,
                bins = bins)
#ambi
bins2 <- c(0,1.2,3.3,4.3,5.5,7)
pal2 <- colorBin(c("blue","green","yellow","orangered","red"),
                domain = mambiI$Vind,pretty = T,
                bins = bins2)

fi %>%
  addCircles(
    data = mambiI,
    lng = ~coords.x1,  # longitude
    lat = ~coords.x2,  # latitude
    popup = ~paste0(
      "station : ", st, "<br/>",
      "année : ", camp, "<br/>",
      "indice : ", Vind
    ),
    fillOpacity = 0,
    opacity = 1,
    radius = 10,
    color = ~ifelse(
      Tind == "AMBI",
      pal2(Vind),
      pal(Vind)
    )
  )

```


Data {data-icon="fa-table"}
=====================================

Column {data-width=700}
-----------------------------------------------------------------------
### Liste des espèces

```{r}
  datatable (eti,filter = "top",  
    extensions = c("Scroller",'Buttons'),
    rownames = FALSE,style = "bootstrap",
    class = "compact",width = "50%",
    options = list(dom = "Btip",
      deferRender = T,scrollY = 430,
      scroller = TRUE, extensions = 'Responsive',
      buttons = list(list(extend = 'excel',filename = 'data-benthos',
title = "Data benthos - Ensemble des données")),
      columnDefs = list(list(visible = FALSE,targets = c(1,2)))))
```

Column {data-width=500}
-----------------------------------------------------------------------
#### Origines des données

Cinq campagnes de prélèvements benthiques ont été conduites depuis 1987 sur l'espace intertidal du fond de baie de Saint-Brieuc et sutidal proche :

* La première cartographie des habitats intertidaux et subtidaux a été réalisée par Gros et Hamon en 1987 au sud d'une ligne Pointe de Saint-Quay Portrieux- Cap d'Erquy

* Une seconde campagne a été réalisée en 2001 sur la zone intertidale du fond de la baie par l'IFREMER et la station marine du MNHN de Dinard (Le Mao *et al.*, 2002).

* Les deux campagnes de terrains conduites en interne par l'équipe de la Réserve naturelle en automne 2010 et au printemps 2011 sur la zone intertidale du fond de la baie de St Brieuc.

* Une cinquième campagne est en cours de réalisation dans le cadre du programme de recherche ResTroph sur l'ensemble du site intertidal et subtidal au sud d'une ligne entre Saint-Quay et Pléneuf-Val André.

[Une synthèse des résultats des assemblages benthiques et des faciès sédimentaires des substrats meubles intertidaux du fond de baie de Saint-Brieuc - Cartographie, analyse et évolution de 1987 à 2011 est disponible ici.](https://www.saintbrieuc-armor-agglo.bzh/fileadmin/RESERVE_DE_LA_BAIE/DOCUMENTATION/doc_de_synthese/Synthese_Benthos.pdf)

### Programme ResTroph

<a href='https://www.reservebaiedesaintbrieuc.com/gerer/strategie-scientifique/programmes-de-recherche-en-cours/restroph' target='_blank'>**En savoir plus sur le programme ResTroph**</a>

<a href='https://www.reservebaiedesaintbrieuc.com/sbaa_reservebaie/RSerena/Benthos-inventaires.html' target='_blank'>**Ensemble des inventaires benthiques mené en Baie de Saint-brieuc**</a>


Partenaires {data-icon="fa-user-friends"}
=====================================

#### Les partenaires du programme ResTroph:
<img src="LOGO.jpg" alt="drawing" width="800"/>
