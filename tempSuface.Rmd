---
title: "Température eau de surface"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    navbar:
      - { title: "Accueil RSerena", href: "https://www.reservebaiedesaintbrieuc.com/sbaa_reservebaie/RSerena/accueil.html", align: rigth }
---

<style>                     
.navbar {
  background-color:#CD2626;
  border-color:#006400;}
  .navbar-inverse .navbar-nav > li > a:hover,
.navbar-inverse .navbar-nav > li > a:focus {
    background-color: #ec4f4f;
    color: black;}
.navbar-inverse .navbar-nav > .active > a,
.navbar-inverse .navbar-nav > .active > a:hover,
.navbar-inverse .navbar-nav > .active > a:focus {
  color: white;
  background-color: #851616;}
.navbar-brand {
color:white!important;}
.chart-title {
  color: #006400;}
.nav-tabs-custom > .nav-tabs > li.active {border-top-color: #ec4f4f}
.nav-tabs-custom .nav-tabs li.active a {color: #8A857C;}
.nav-tabs-custom .nav-tabs li:not(.active) a { color: red;}
</style>
```{css my-content, echo = FALSE}
.value-box {
    height: 15%;}
```


```{r setup, include=FALSE,message=FALSE}
library(flexdashboard)
library(RODBC)
library(gplots)
library(lattice)
library(doBy)
library(shiny)
library(DT)
library(chron)
library(kableExtra)
library(plotly)
##OUVERTURE des données dans la base local SERENA bio
adres<-getwd()
channel <-  odbcConnectAccess2007(gsub("RserenaSQL",  "BDE_BSBbio.mdb"  ,adres))
dataT  <-  sqlFetch(channel, "BSB_tempEau",colnames = F, rownames = F)
close(channel)
attach(dataT)
#dataT<-dataT[-c(334:336),]
#####################################
#date au format posixct- Date au format chr en francais
date<-strptime(dataT[,c(2)], '%Y-%m-%d')
date<-format(date, "%d/%m/%Y")
Date<-dataT[,c(2)]
Temp<-round(dataT[,c(3)],1)
mois<-substr(Date, 6, 7)
ann<-substr(Date, 1, 4)
jour<-as.numeric(substr(Date, 9, 10))
quin<-ifelse(jour <15, 1, 2)
mq<-paste(mois,quin, sep="-")
m<-max(ann)
m1<-as.numeric(max(ann))-1
mn<-as.numeric(m)
mm<-min(ann)
data<-data.frame(mq,Date,Temp,as.numeric(mois),
                 as.numeric(ann), jour,date)
colnames(data)<-c("quin","date","Temp","mois","ann","jour","Date")
dataN<-data[data$ann==m,]
dataN1<-data[data$ann==(m1),]
dataN$mois<-as.numeric(as.character(dataN$mois))
row.names(dataN)<-seq(1:dim(dataN)[1])
row.names(dataN1)<-seq(1:dim(dataN1)[1])
########################################
#annee complete pour courbe tendence
anCour<-paste(m,"-01-01 00:00:00", sep="")
dataAC<-data[data$date>"2007-12-31 00:00:00"
             & data$date<anCour,]
#tendance saison
dataEte<-data[data$mois %in% c(6,7,8),]
dataHiv<-data[data$mois %in% c(12,1,2),]
dataPri<-data[data$mois %in% c(3,4,5),]
dataAut<-data[data$mois %in% c(9,10,11),]
#filtre saison partielle
if(length(dataPri$ann[dataPri$ann %in% max(dataPri$ann)])<3){
  dataPri<-dataPri[dataPri$ann <mn,]}
if(length(dataEte$ann[dataEte$ann %in% max(dataEte$ann)])<3 ){
  dataEte<-dataEte[dataEte$ann <mn,]}
if(length(dataAut$ann[dataAut$ann %in% max(dataAut$ann)])<3){
  dataAut<-dataAut[dataAut$ann <mn,]}
if(length(dataHiv$ann[dataHiv$ann %in% max(dataHiv$ann)])<3){
  dataHiv<-dataHiv[dataHiv$ann <mn,]}
###########################################
#tableau mensuel
m.mean<-tapply(Temp, mois, mean)
m.sd<-tapply(Temp, mois, sd)
m.max<-tapply(Temp, mois, max)
m.min<-tapply(Temp, mois, min)
a.min<-numeric(12)
a.max<-numeric(12)
for (i in 1:12){
  a.min[i]<-data$ann[data$Temp %in% m.min[i] & data$mois %in% c(i)]}
for (i in 1:12){
  a.max[i]<-data$ann[data$Temp %in% m.max[i] & data$mois %in% c(i)]}
m.n<-tapply(Temp, mois, length)
num.m<-1:12
#intervalle confiance moyenne
ci<-qt(0.975, (m.n)) * sqrt((m.sd^2)/(m.n))
cip<-m.mean+(qt(0.975, (m.n)) * sqrt((m.sd^2)/(m.n)))
cim<-m.mean+(qt(0.025, (m.n)) * sqrt((m.sd^2)/(m.n)))
#prepa tab
tm<-as.data.frame(cbind(m.mean,m.sd,cim,cip,m.max,a.max,m.min,a.min,m.n))
colnames(tm)<-c("mean","sd","ci-inf","ci-sup","max","annee","min","annee","n")
tm[,c(1:4)]<-round(tm[,c(1:4)],1)
######################################
#tableau par quinzaine
mq.mean<-tapply(Temp, mq, mean)
mq.sd<-tapply(Temp, mq, sd)
mq.max<-tapply(Temp, mq, max)
mq.min<-tapply(Temp, mq, min)
mq.n<-tapply(Temp, mq, length)
#intervalle confiance moyenne
ciq<-qt(0.975, (mq.n)) * sqrt((mq.sd^2)/(mq.n))
ciqp<-mq.mean+(qt(0.975, (mq.n)) * sqrt((mq.sd^2)/(mq.n)))
ciqm<-mq.mean+(qt(0.025, (mq.n)) * sqrt((mq.sd^2)/(mq.n)))
#prepa tab
tmq<-as.data.frame(cbind(mq.mean,mq.sd,ciqm,ciqp,mq.max,
                         mq.min,mq.n))
colnames(tmq)<-c("mean","sd","ci-inf","ci-sup","max","min","n")
tmq[,c(1:4)]<-round(tmq[,c(1:4)],1)
#####################################
#tableau synthèse moyenne mensuelle par annee
tmp<-aggregate(data[,c(3)], list(mois, ann), mean)
colnames(tmp)<-c("mois","annee","temp")
tmp<-tmp[order(tmp[,1],decreasing=F), ]
tabMoyAnn<-reshape(tmp,idvar="annee",
                   timevar="mois", direction="wide")
tabMoyAnn<-tabMoyAnn[order(tabMoyAnn[,1],decreasing=F), ]
row.names(tabMoyAnn)<-tabMoyAnn[,1]
tabMoyAnn<-tabMoyAnn[,-1]
colnames(tabMoyAnn)<-seq(1:12)
tabMoyAnn<- round(tabMoyAnn,2)
#tableau synthèse moyenne quinzaine par annee
tmpq<-aggregate(data[,c(3)], list(as.factor(data$quin), ann), mean)
colnames(tmpq)<-c("quinz","annee","temp")
tmpq<-tmpq[order(tmpq[,1],decreasing=F), ]
tabMoyQuin<-reshape(tmpq,idvar="annee",
                   timevar="quinz", direction="wide")
tabMoyQuin<-tabMoyQuin[order(tabMoyQuin[,1],decreasing=F), ]
row.names(tabMoyQuin)<-tabMoyQuin[,1]
tabMoyQuin<-tabMoyQuin[,-1]
colnames(tabMoyQuin)<-names(mq.mean)
tabMoyQuin<- round(tabMoyQuin,2)
#####################################
#####################################
#tab synthèse global moyenne + année en cours
tm$mois<-(1:length(tm$mean))
tA<-summaryBy(Temp~mois,data=dataN,FUN=c(mean,min,max))
tA$Temp.mean<-round(tA$Temp.mean,1)
tmtA<-merge(tm,tA,by.x="mois", by.y="mois" ,all.x=T)
colnames(tmtA)<-gsub("Temp",m,colnames(tmtA) )

#tab synthese gloabl par quinzaine
tmpN<-merge(dataN1[,c(1:3)],dataN[,c(1:3)],
      by.x="quin", by.y="quin",all.x=T) 
tmtQ<-merge(tmq,tmpN,by.x="row.names", by.y="quin" ,all.x=T)
colnames(tmtQ)<-gsub("date.x",m1,colnames(tmtQ) )
colnames(tmtQ)<-gsub("Temp.x",paste0("T°",m1),colnames(tmtQ) )
colnames(tmtQ)<-gsub("date.y",m,colnames(tmtQ) )
colnames(tmtQ)<-gsub("Temp.y",paste0("T°",m),colnames(tmtQ) )
colnames(tmtQ)<-gsub("Row.names","quinzaine",colnames(tmtQ) )
#tendance
#dataAC<-dataAC[dataAC$date<anCour,]
nlmT<-lowess(dataAC$date,dataAC$Temp,f=.5)
Tentot<-mean(nlmT$y[length(nlmT$y):(length(nlmT$y)-5)])-mean(nlmT$y[1:5])
#calcul tendance ete
nlmE<-lowess(dataEte$date,dataEte$Temp,f=.5)
TenE<-mean(nlmE$y[length(nlmE$y):(length(nlmE$y)-5)])-mean(nlmE$y[1:5])
#calcul tendance hiver
nlmH<-lowess(dataHiv$date,dataHiv$Temp,f=.5)
TenH<-mean(nlmH$y[length(nlmH$y):(length(nlmH$y)-5)])-mean(nlmH$y[1:5])
#calcul tendance prin
nlmP<-lowess(dataPri$date,dataPri$Temp,f=.5)
TenP<-mean(nlmP$y[(length(nlmP$y)):(length(nlmP$y)-5)])-mean(nlmP$y[1:5])
#calcul tendance autmne
nlmA<-lowess(dataAut$date,dataAut$Temp,f=.5)
TenA<-mean(nlmA$y[length(nlmA$y):(length(nlmA$y)-5)])-mean(nlmA$y[1:5])
#########################
#Calcul anomalie climatique
#annuel
a.mean<-tapply(dataAC$Temp, dataAC$ann, mean)-mean(dataAC$Temp)
#calcul pour l'année en cours
dataPeriode<-data[data$quin %in% dataN$quin,]
moyAnneeN<-mean(dataN$Temp)-mean(dataPeriode$Temp)
a.mean<-append(a.mean, moyAnneeN)
names(a.mean)[length(a.mean)]<-mn
#couleur ecart
mycols <- c("blue","red")
a.coul<-mycols[cut(a.mean,breaks=c(-2,0,2),labels=FALSE)]
AnoAnn<-data.frame(annee=names(a.mean),ecart=a.mean,sens=a.coul)
#par saison
h.mean<-tapply(dataHiv$Temp, dataHiv$ann, mean)-mean(dataHiv$Temp)
h.coul<-mycols[cut(h.mean,breaks=c(-3,0,3),labels=FALSE)]
AnoH<-data.frame(annee=names(h.mean),ecart=h.mean,sens=h.coul)
#
p.mean<-tapply(dataPri$Temp, dataPri$ann, mean)-mean(dataPri$Temp)
p.coul<-mycols[cut(p.mean,breaks=c(-3,0,3),labels=FALSE)]
AnoP<-data.frame(annee=names(p.mean),ecart=p.mean,sens=p.coul)
#
e.mean<-tapply(dataEte$Temp, dataEte$ann, mean)-mean(dataEte$Temp)
e.coul<-mycols[cut(e.mean,breaks=c(-3,0,3),labels=FALSE)]
AnoE<-data.frame(annee=names(e.mean),ecart=e.mean,sens=e.coul)
#
aut.mean<-tapply(dataAut$Temp, dataAut$ann, mean)-mean(dataAut$Temp)
aut.coul<-mycols[cut(aut.mean,breaks=c(-3,0,3),labels=FALSE)]
AnoA<-data.frame(annee=names(aut.mean),ecart=aut.mean,sens=aut.coul)

```


Relevés {data-icon="fa-area-chart"}
=====================================

Row {data-width=250}
-----------------------------------------------------------------------

Température mesurée à St Guimond (anse d'Yffiniac), à l'aube, par coefficient compris entre 80 et 90 (2 mesures par mois).

### Période

```{r}
valueBox(paste(min(ann),max(ann),sep="-"), icon = "fa-pencil",
         col="#CD2626")
```

### T°ninimum

```{r}
valueBox(min(Temp), icon = "ion-arrow-graph-down-right", col="#104E8B")
```

### T°maximum

```{r}
valueBox(max(Temp), icon = "ion-arrow-graph-up-right", col="#8B1A1A")
```

### T°moyenne

```{r}
valueBox(paste(round(mean(Temp),2), round(sd(Temp),2), sep="+/-"), icon = "ion-code-working", col="#CD2626")
```

### Nombre de mesures

```{r}
valueBox(length(Temp), icon = "ion-drag", col="#CD2626")
```


Row {data-width=800}
-----------------------------------------------------------------------



```{r,message=FALSE}
ln<-predict(lm(Temp~Date))
nlm<-lowess(dataAC$date,dataAC$Temp,f=.5)
nlmE<-lowess(dataEte$date,dataEte$Temp,f=.5)
nlmH<-lowess(dataHiv$date,dataHiv$Temp,f=.5)
nlmP<-lowess(dataPri$date,dataPri$Temp,f=.5)
nlmA<-lowess(dataAut$date,dataAut$Temp,f=.5)
mT<-mean(Temp)
#graphe potly
FL <- plot_ly(x = ~Date, 
              y = ~Temp, name = 'mesure', 
              type = 'scatter',height = 600,width = 1000, 
              mode = 'lines',showlegend = FALSE,
              line = list(color = "forestgreen"),color = I('forestgreen'),
              hovertemplate = paste('%{y:.0f}'))%>%
  add_lines(x = ~dataAC$date, y = ~nlm$y,name = "Tendance général",
            line = list(color="blue", width = .5),showlegend = T,
            hovertemplate = paste('%{y:.2f}'))%>%
    add_lines(x = ~dataPri$date, y = ~nlmP$y,name = "Tendance du printemps",
            line = list(color="#ADFF2F", width = .5),showlegend = T,
            hovertemplate = paste('%{y:.2f}'))%>%
  add_lines(x = ~dataEte$date, y = ~nlmE$y,name = "tendance de l'été",
            line = list(color="#B22222", width = .5),showlegend = T,
            hovertemplate = paste('%{y:.2f}'))%>%
    add_lines(x = ~dataAut$date, y = ~nlmA$y,name = "Tendance de l'automne",
            line = list(color="#FF8C00", width = .5),showlegend = T,
            hovertemplate = paste('%{y:.2f}'))%>%
  add_lines(x = ~dataHiv$date, y = ~nlmH$y,name = "tendance de l'hiver",
            line = list(color="#00BFFF", width = .5),showlegend = T,
            hovertemplate = paste('%{y:.2f}'))%>%
  add_trace(y = ~mT , 
            name = 'moyenne', mode = 'lines',showlegend = T,
            line = list(color="blue", width = .5, dash = 'dash'),
            hovertemplate = paste('%{y:.2f}'))%>%
  layout(yaxis = list(title = "T°C"), 
         xaxis = list(title = "année",zeroline = FALSE,
                      nticks=mn-2007),
         hovermode = "x unified",
         legend = list(orientation = 'h',
                       font = list(size = 10)))
FL
```

Saison {data-icon="fa-sliders"}
=====================================

Row {data-width=200}
--------------------------------------------------

```{r, message=FALSE}
plot_ly(width = 220, height = 520,AnoAnn, x = ~ecart, y = ~annee, type = 'bar', orientation = 'h',
        marker = list(color =AnoAnn$sens),showlegend = F,
        name = "Ecart à la moyenne",
        hovertemplate = paste('%{x:.2f}'))
```

Ecart à la normale des températures moyennes annuelles depuis 2008

## Row {data-width=250}
---------------------------------------


### mars, avril, mai
```{r}
valueBox("Printemps", icon = "fa-leaf",
         col="#228B22")
```

### Minimum
```{r}
valueBox(min(dataPri$Temp), icon = "fa-angle-down", col="#228B22")
```

### Maximum
```{r}
valueBox(max(dataPri$Temp), icon = "fa-angle-up", col="#228B22")
```

### Moyenne
```{r}
valueBox(paste(round(mean(dataPri$Temp),2), round(sd(dataPri$Temp),2), sep="+/-"), icon = "fa-angle-right", col="#228B22")
```

### Augmentation de la température
```{r}
gauge(round(TenP,2), min = 0, max = 2, gaugeSectors(
  success = c(0, 2)),symbol="°C")
```


Row {data-width=250}
---------------------------------------

### juin, juillet, août
```{r}
valueBox("Eté", icon = "fa-sun",
         col="#B22222")
```

### Minimum
```{r}
valueBox(min(dataEte$Temp), icon = "fa-angle-down", col="#B22222")
```

### Maximum
```{r}
valueBox(max(dataEte$Temp), icon = "fa-angle-up", col="#B22222")
```

### Moyenne
```{r}
valueBox(paste(round(mean(dataEte$Temp),2), round(sd(dataEte$Temp),2), sep="+/-"), icon = "fa-angle-right", col="#B22222")
```

### Augmentation de la température
```{r}
gauge(round(TenE,2), min = 0, max = 2, gaugeSectors(
  danger = c(0, 2)),symbol="°C")
```

Row {data-width=250}
---------------------------------------

### Sept, octobre, nov.
```{r}
valueBox("Automne", icon = "fa-cannabis",
         col="#CD6600")
```

### Minimum
```{r}
valueBox(min(dataAut$Temp), icon = "fa-angle-down", col="#CD6600")
```

### Maximum
```{r}
valueBox(max(dataAut$Temp), icon = "fa-angle-up", col="#CD6600")
```

### Moyenne
```{r}
valueBox(paste(round(mean(dataAut$Temp),2), round(sd(dataAut$Temp),2), sep="+/-"), icon = "fa-angle-right", col="#CD6600")
```

### Augmentation de la température
```{r}
gauge(round(TenA,2), min = 0, max = 2, gaugeSectors(
  warning = c(0, 2)),symbol="°C")
```

Row {data-width=250}
---------------------------------------

### dec, janv, fev
```{r}
valueBox("Hiver", icon = "fa-dove",
         col="#104E8B")
```

### Minimum
```{r}
valueBox(min(dataHiv$Temp), icon = "fa-angle-down", col="#104E8B")
```

### Maximum
```{r}
valueBox(max(dataHiv$Temp), icon = "fa-angle-up", col="#104E8B")
```

### Moyenne
```{r}
valueBox(paste(round(mean(dataHiv$Temp),2), round(sd(dataHiv$Temp),2), sep="+/-"), icon = "fa-angle-right", col="#104E8B")
```

### Augmentation de la température
```{r}
gauge(round(TenH,2), min = 0, max = 2, gaugeSectors(
  colors=c("primary")),symbol="°C")
```

Mensuel {data-icon="fa-table"}
=====================================

## Row {.tabset}
--------------------------------------------------
### Synthèse



```{r}
txt1<-paste0("Synthèse ",min(ann),"-",max(ann))
txt2<-max(ann)
myHeader <-c(txt1 = 10, txt2 = 3)
names(myHeader) <- c(txt1,txt2)
opts <- options(knitr.kable.NA = "")
knitr::kable(tmtA,align=c("c"))%>%
column_spec (c(5,10),border_left = F, border_right = T)%>%
  column_spec(1, bold = TRUE) %>% 
  column_spec(c(3:5,10), italic = TRUE) %>% 
  column_spec(c(2,11), color = 'forestgreen')%>%
   column_spec(c(6,13), color = '#B22222')%>%
  column_spec(c(8,12), color = '#104E8B')%>%
  add_header_above(myHeader) %>% 
kable_styling()
```



### Moyenne

```{r}

datatable(tabMoyAnn, rownames = T, class = 'cell-border stripe',
          options = list(dom = 't', pageLength = -1, 
                    lengthMenu = list(c(-1), c('All')),
                          deferRender = T,scrollY = 600,
      scroller = TRUE, extensions = 'Responsive',
                     columnDefs = list(list(width = '50px', targets = "_all")),autoWidth = F,
                         initComplete = htmlwidgets::JS(
                           "function(settings, json) {",
paste0("$(this.api().table().container()).css({'font-size': '", "8pt", "'});"),"}"))
)%>%
  formatStyle(colnames(tabMoyAnn)[1],
              Color = styleInterval(m.mean[1], c("blue","red")),
              backgroundColor=styleInterval(c(cim[1], cip[1]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyAnn)[2],
              Color = styleInterval(m.mean[2], c("blue","red")),
              backgroundColor=styleInterval(c(cim[2], cip[2]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyAnn)[3],
              Color = styleInterval(m.mean[3], c("blue","red")),
              backgroundColor=styleInterval(c(cim[3], cip[3]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyAnn)[4],
              Color = styleInterval(m.mean[4], c("blue","red")),
              backgroundColor=styleInterval(c(cim[4], cip[4]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyAnn)[5],
              Color = styleInterval(m.mean[5], c("blue","red")),
              backgroundColor=styleInterval(c(cim[5], cip[5]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyAnn)[6],
              Color = styleInterval(m.mean[6], c("blue","red")),
              backgroundColor=styleInterval(c(cim[6], cip[6]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyAnn)[7],
              Color = styleInterval(m.mean[7], c("blue","red")),
              backgroundColor=styleInterval(c(cim[7], cip[7]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyAnn)[8],
              Color = styleInterval(m.mean[8], c("blue","red")),
              backgroundColor=styleInterval(c(cim[8], cip[8]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyAnn)[9],
              Color = styleInterval(m.mean[9], c("blue","red")),
              backgroundColor=styleInterval(c(cim[9], cip[9]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyAnn)[10],
              Color = styleInterval(m.mean[10], c("blue","red")),
              backgroundColor=styleInterval(c(cim[10], cip[10]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyAnn)[11],
              Color = styleInterval(m.mean[11], c("blue","red")),
              backgroundColor=styleInterval(c(cim[11], cip[11]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyAnn)[12],
              Color = styleInterval(m.mean[12], c("blue","red")),
              backgroundColor=styleInterval(c(cim[12], cip[12]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))
```


### Graphique
```{r, message=FALSE}
moisN<-substr(dataN$date, 6, 7)
ln<-lowess(dataN$Temp ~ dataN$mois, f=.2)
mycols2 <- c("forestgreen","red")
a.coul2<-mycols2[cut(data$ann,breaks=c(2006,mn-1,mn+1),labels=FALSE)]

grFig<-plot_ly(height = 500,width = 1300,
               data = data,x = ~mois, y = ~Temp,
               text=paste(date,":",Temp,"T°C"),
               hoverinfo = 'text',
               type = 'scatter',alpha = 0.65,
               mode = 'markers',showlegend = T,
               marker = list(color =a.coul2),
               name=paste("En vert : ensemble des mesures de",
                          mm,"-",m, sep=" ")
               )%>% 
  add_lines(x = ~moisN, y = ~ln$y,text="",
            name=paste("En rouge : mesure pour l'année",m, sep=" "),
            line = list(color="red", width = .5),showlegend = T)%>% 
  add_lines(x = ~row.names(tm), y = ~tm[,1],text="",
            line = list(color="forestgreen", width = .5),showlegend = T,
            name=paste("moyenne de",
                          mm,"-",m, sep=" "))%>% 
  add_lines(x = ~row.names(tm), y = ~tm[,3],text="",
            line = list(color="forestgreen",dash = 'dot', width = .5),
            showlegend = F)%>%  
  add_lines(x = ~row.names(tm), y = ~tm[,4],text="",
            line = list(color="forestgreen",dash = 'dot', width = .5),
            showlegend = F)%>%
  layout(yaxis = list(title = "T°C"), 
         xaxis = list(title = "mois",zeroline = FALSE))

grFig
```


Bimensuel {data-icon="fa-table"}
=====================================

## Row {.tabset}
--------------------------------------------------
### Synthèse
              
```{r}
txt1<-paste0("Synthèse ",min(ann),"-",max(ann))
txt2<-m1
txt3<-m
myHeader2 <-c(txt1 = 8, txt2 = 2,txt3=2)
names(myHeader2) <- c(txt1,txt2,txt3)
opts <- options(knitr.kable.NA = "")
knitr::kable(tmtQ,align=c("c","c","c","c","c","c","c","c","c"))%>%
column_spec (c(8,10),border_left = F, border_right = T)%>%
  column_spec(1, bold = TRUE) %>% 
  column_spec(c(3:5,10), italic = TRUE) %>% 
  column_spec(c(2,10,12), color = 'forestgreen')%>%
   column_spec(c(6), color = '#B22222')%>%
  column_spec(c(7), color = '#104E8B')%>%
  add_header_above(myHeader2) %>% 
kable_styling()

```
 
### Moyenne

```{r}
datatable(tabMoyQuin, rownames = T, class = 'cell-border stripe',
          options = list(dom = 't', pageLength = -1,  
                         lengthMenu = list(c(-1), c('All')),
                             deferRender = T,scrollY = 600,
      scroller = TRUE, extensions = 'Responsive',
                         columnDefs = list(list(width = '20px', targets = "_all")),autoWidth = F,
                         initComplete = htmlwidgets::JS(
                           "function(settings, json) {",
                           paste0("$(this.api().table().container()).css({'font-size': '", "8pt", "'});"),"}")
          )) %>%
formatStyle(colnames(tabMoyQuin)[1],
              Color = styleInterval(mq.mean[1], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[1], ciqp[1]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
formatStyle(colnames(tabMoyQuin)[2],
            Color = styleInterval(mq.mean[2], c("blue","red")),
            backgroundColor=styleInterval(c(ciqm[2], ciqp[2]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
formatStyle(colnames(tabMoyQuin)[3],
            Color = styleInterval(mq.mean[3], c("blue","red")),
            backgroundColor=styleInterval(c(ciqm[3], ciqp[3]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
formatStyle(colnames(tabMoyQuin)[4],
            Color = styleInterval(mq.mean[4], c("blue","red")),
            backgroundColor=styleInterval(c(ciqm[4], ciqp[4]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
formatStyle(colnames(tabMoyQuin)[5],
            Color = styleInterval(mq.mean[5], c("blue","red")),
            backgroundColor=styleInterval(c(ciqm[5], ciqp[5]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
formatStyle(colnames(tabMoyQuin)[6],
            Color = styleInterval(mq.mean[6], c("blue","red")),
            backgroundColor=styleInterval(c(ciqm[6], ciqp[6]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
formatStyle(colnames(tabMoyQuin)[7],
            Color = styleInterval(mq.mean[7], c("blue","red")),
            backgroundColor=styleInterval(c(ciqm[7], ciqp[7]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
formatStyle(colnames(tabMoyQuin)[8],
            Color = styleInterval(mq.mean[8], c("blue","red")),
            backgroundColor=styleInterval(c(ciqm[8], ciqp[8]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[9],
              Color = styleInterval(mq.mean[9], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[9], ciqp[9]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[10],
              Color = styleInterval(mq.mean[10], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[10], ciqp[10]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[11],
              Color = styleInterval(mq.mean[11], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[11], ciqp[11]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[12],
              Color = styleInterval(mq.mean[12], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[12], ciqp[12]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[13],
              Color = styleInterval(mq.mean[13], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[13], ciqp[13]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[14],
              Color = styleInterval(mq.mean[14], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[14], ciqp[14]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[15],
              Color = styleInterval(mq.mean[15], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[15], ciqp[15]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[16],
              Color = styleInterval(mq.mean[16], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[16], ciqp[16]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[17],
              Color = styleInterval(mq.mean[17], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[17], ciqp[17]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[18],
              Color = styleInterval(mq.mean[18], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[18], ciqp[18]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[19],
              Color = styleInterval(mq.mean[19], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[19], ciqp[19]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[20],
              Color = styleInterval(mq.mean[20], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[20], ciqp[20]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[21],
              Color = styleInterval(mq.mean[21], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[21], ciqp[21]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[22],
              Color = styleInterval(mq.mean[22], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[22], ciqp[22]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[23],
              Color = styleInterval(mq.mean[23], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[23], ciqp[23]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))%>%
  formatStyle(colnames(tabMoyQuin)[24],
              Color = styleInterval(mq.mean[24], c("blue","red")),
              backgroundColor=styleInterval(c(ciqm[24], ciqp[24]), c("rgb(201,201,201)",'white',"rgb(201,201,201)")))

```

### Graphique

```{r fig.height=10, fig.width=15}

tmq$numQ<-as.numeric(substr(row.names(tmq),4, 4))
tmq$mois<-as.numeric(substr(row.names(tmq),1, 2))

#duplication des points de l'année si il y a qu'un point pr quinzaine
psupinf15<-rbind(dataN[which(dataN$jour<15),],dataN[which(dataN$jour<15),])
psupsup15<-rbind(dataN[which(dataN$jour>=15),],dataN[which(dataN$jour>=15),])

grFigQ<-plot_ly(data = tmq[which(tmq$numQ ==1),],
                x = ~mois, y = ~mean, type = 'scatter', mode = 'lines+markers',name = paste("1ère quinzaine, moyenne",mm,"-",m, sep=" "),
                showlegend = T,
                marker = list(size =5,color = 'rgba(11, 124, 246, .6)'),
                line=list(color = 'blue', width = 1, dash = 'dash'),
                error_y = ~list(array = sd,
                              color = 'rgba(11, 124, 246, .6)'))%>%
  add_trace(data = tmq[which(tmq$numQ == 2),], 
            mode = 'lines+markers',
        name = paste("2ème quinzaine, moyenne",mm,"-",m, sep=" "),
        showlegend = T,
            error_y = ~list(array = sd,color ='forestgreen'),
            line=list(color = 'forestgreen', width = 1, dash = 'dash'),
            marker = list(size = 5,color = 'rgba(34, 139, 34, .9)'),
            error_y = ~list(array = sd,color = 'rgba(34, 139, 34, .3)'))%>%
  add_markers(data = psupinf15,
              x = ~mois, y = ~Temp,type = 'scatter',mode='lines+markers',
              name = paste("1ère quinzaine ",m, sep=""),
              line=list(color = 'white'),
              marker = list(size = 6,symbol ="square-dot",
                            color = 'rgba(11, 124, 246, .9)',
                            line = list(color = 'rgba(0,0,0, 1)',
                                        width = 1)))%>%
  add_markers(data = psupsup15,
              x = ~mois, y = ~Temp,type = 'scatter',mode='lines+markers',
              name = paste("2ème quinzaine ",m, sep=""),
              line=list(color = 'white'),
              marker = list(size = 6,symbol ="square-dot",
                            color = 'rgba(34, 139, 34, .8)',
                            line = list(color = 'rgba(0,0,0, 1)',
                                        width = .5)))%>%
  layout(yaxis = list(title = "T°C"), 
         xaxis = list(title = "mois",zeroline = FALSE,
                      dtick=1))

grFigQ
```

Data {data-icon="fa-book"}
=====================================

Row {data-width=250}
-----------------------------------------------------------------------

Les température mesurée à St Guimond (anse d'Yffiniac), à l'aube, par coefficient compris entre 80 et 90 (2 mesures par mois) depuis 2007. Il s'agit d'une mesure de la température en surface de l'eau (20cm).


### 

![](logo/logo.png)

### Nombre de mesures

```{r}
valueBox(length(Temp), icon = "ion-drag", col="#CD2626")
```

### T°ninimum

```{r}
valueBox(min(Temp), icon = "ion-arrow-graph-down-right", col="#104E8B")
```

### T°maximum

```{r}
valueBox(max(Temp), icon = "ion-arrow-graph-up-right", col="#8B1A1A")
```

### T°moyenne

```{r}
valueBox(paste(round(mean(Temp),2), round(sd(Temp),2), sep="+/-"), icon = "ion-code-working", col="#CD2626")
```




Column {data-width=900}
-----------------------------------------------------------------------

###
```{r,message=FALSE}
dataE<-data[c(7,6,4,1,5,3)]
dataE[,1]<-as.Date(dataE[,1],"%d/%m/%Y")
colnames(dataE)<-c("date","jour","mois","quinzaine","année","T°c")
  datatable (dataE,filter = "top",  
    extensions = c("Scroller",'FixedColumns','Buttons'),
    rownames = FALSE,style = "bootstrap",
    class = 'compact',
    options = list(dom = "rBt",
               deferRender = T,scroller = F,
               pageLength = 1000,
               extensions = 'Responsive',
               buttons = list(
              list(extend = 'excel',filename = 'data-Température',
title = "Suivi Température eau de surface (St Guimond-Hillion")), 
      columnDefs = list(list(className = 'dt-center', targets = c(1:5))))) %>%
   formatStyle(6,color = 'blue', fontWeight = 'bold')%>%
  formatDate(1, 'toLocaleDateString')
```


